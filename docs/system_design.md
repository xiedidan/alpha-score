# Binance Alpha 自动化交易工具系统设计文档

> **文档版本**：v1.1
> **创建日期**：2025-11-25
> **基于**：需求文档 v1.0 + 需求调研问卷
> **更新日志**：修正积分计算公式为阶梯制，精简代码示例，增加 AI Agent 配置

---

## 目录
1. [需求总结与设计目标](#1-需求总结与设计目标)
2. [系统架构设计](#2-系统架构设计)
3. [核心模块详细设计](#3-核心模块详细设计)
4. [数据模型设计](#4-数据模型设计)
5. [接口设计规范](#5-接口设计规范)
6. [关键技术方案](#6-关键技术方案)
7. [开发计划与迭代路线](#7-开发计划与迭代路线)
8. [开发规范与约定](#8-开发规范与约定)
9. [风险评估与应对策略](#9-风险评估与应对策略)

---

## 1. 需求总结与设计目标

### 1.1 核心需求提炼

#### 业务目标
- **主要目标**：最大化 Alpha Points 积分收益（目标：16-18 分/天）
- **次要目标**：通过网格交易创造额外收益，对冲交易磨损成本
- **效率目标**：降低手动操作工作量，提升交易执行速度和精度

#### 用户痛点
1. **速度问题**：难以跟上盘口变动速度
2. **精度问题**：难以手动精确调整价格
3. **感知问题**：缺乏准确的行情感知（ATR 等技术指标）
4. **失误问题**：手动操作容易出错

#### 功能优先级（基于问卷反馈）
1. **风控与安全防护**（最高优先级）
2. **Alpha 积分自动获取功能**
3. **网格交易功能**（重要但非紧急）
4. **Web 管理界面**
5. **OSD 实时显示**

#### 开发阶段优先级
1. Web 管理界面 → 2. OSD 显示 → 3. LLM 能力接入 → 4. MVP 核心功能 → 5. 完整系统 → 6. 网格交易

---

### 1.2 系统设计原则

#### 1.2.1 隐蔽性原则（最高优先级）
**目标**：极致模拟人类行为，规避平台风控

**设计要点**：
- 使用远程调试连接已登录浏览器（复用真实会话指纹）
- 所有操作注入随机延迟（可配置范围）
- 鼠标移动采用贝塞尔曲线（非直线）
- 定期执行随机浏览行为（滚动、悬停、阅读）
- 避免固定时间间隔的规律性操作

#### 1.2.2 安全性原则
**目标**：保护用户资金和账户安全

**设计要点**：
- 系统自身需要用户名+密码登录
- 敏感配置加密存储
- 所有操作记录详细日志（便于审计）
- 严格的风控检查（ATR、仓位、交易量）
- 异常情况自动暂停并通知用户

#### 1.2.3 稳定性原则
**目标**：7x24 小时稳定运行

**设计要点**：
- 完善的异常处理机制
- 自动重连机制（网络中断、浏览器崩溃）
- 状态持久化（系统重启后可恢复）
- 心跳检测（登录状态、网络连接）
- 优雅降级（部分功能失败不影响核心功能）

#### 1.2.4 可配置性原则
**目标**：所有关键参数支持实时调整

**设计要点**：
- 配置文件化（YAML 格式）
- Web 界面实时修改配置
- 配置变更后热重载（无需重启）
- 配置版本管理（支持回滚）
- 配置校验（防止非法参数）

#### 1.2.5 可观测性原则
**目标**：系统运行状态透明可见

**设计要点**：
- 实时数据监控（盘口、积分、持仓）
- 多层次日志（DEBUG、INFO、WARNING、ERROR）
- 关键指标统计（交易次数、磨损、成功率）
- 可视化图表（K 线、资金曲线、积分趋势）
- 多渠道通知（Discord/Telegram/飞书/PushPlus）

#### 1.2.6 可扩展性原则
**目标**：便于未来功能扩展

**设计要点**：
- 模块化设计（高内聚、低耦合）
- 策略插件化（便于增加新策略）
- 接口抽象化（便于适配其他交易所）
- 数据格式统一（便于数据分析和建模）

---

### 1.3 关键技术参数汇总

| 参数类别 | 具体参数 | 值/范围 | 说明 |
|---------|---------|---------|------|
| **交易基础** | 首选代币 | KOGE/USDT | 可配置 |
| | 可用资金 | 1000-2500 USDT | 专项资金 |
| | 单次仓位 | 30-100% | 可配置 |
| **积分目标** | 每日目标积分 | 16-18 分 | 基于阶梯计算 |
| **风控参数** | ATR 限制 | 可配置 | 用户熟悉 ATR |
| | 每日交易上限 | 根据积分计算 | 达到自动停止 |
| **网格交易** | 目标币种 | KOGE/USDT | 可配置 |
| | 投入资金 | 300-1000 USDT | |
| | 触发方式 | 手动启停 | |
| **部署环境** | 平台 | Hyper-V（Win11） | |
| | 配置 | 1C/8G/20G | |
| | 网络 | 家庭宽带+代理 | |
| **隐蔽性** | 鼠标移动 | 极慢 | 模拟人类 |
| | 随机浏览 | 中等频率 | |

---

## 2. 系统架构设计

### 2.1 总体架构

系统采用**前后端分离 + 浏览器自动化**的架构，分为六个层次：

```
┌─────────────────────────────────────────────────────────────┐
│                         用户层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Web 管理界面  │  │  OSD 显示层   │  │  通知系统     │      │
│  │  (Vue3+Vite) │  │ (Overlay UI) │  │ (Discord/TG) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                             ↕ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                       应用服务层                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              后端服务 (Python FastAPI)                │  │
│  │  • API 网关  • 认证授权  • 配置管理  • 状态管理      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↕
┌─────────────────────────────────────────────────────────────┐
│                      核心业务层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  策略引擎     │  │  风控引擎     │  │  数据采集     │      │
│  │              │  │              │  │              │      │
│  │ • 积分优化   │  │ • ATR 检测   │  │ • 盘口监控   │      │
│  │ • 订单生成   │  │ • 仓位控制   │  │ • 价格采集   │      │
│  │ • 网格策略   │  │ • 异常检测   │  │ • 积分查询   │      │
│  │ • 阶梯计算   │  │ • 止损管理   │  │ • 技术指标   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                             ↕
┌─────────────────────────────────────────────────────────────┐
│                      执行层                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         浏览器自动化引擎 (Playwright)                  │  │
│  │  • 交易执行  • 行为模拟  • 页面控制  • 会话管理      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↕
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                               │
│  • SQLite (交易记录、市场数据、积分历史)                      │
│  • 配置文件 (策略参数、用户配置、阶梯配置)                     │
│  • 日志文件 (操作日志、错误日志、审计日志)                     │
└─────────────────────────────────────────────────────────────┘
                             ↕
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                               │
│  • 币安 Alpha 平台  • LLM API  • 通知渠道                     │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.2 技术栈选型

| 层次 | 技术选型 | 理由 |
|-----|---------|------|
| **前端** | Vue 3 + Vite + TypeScript | 现代化开发，组件化设计，实时更新 |
| | Element Plus / Ant Design Vue | 丰富 UI 组件，快速开发 |
| | ECharts | 数据可视化 |
| **后端** | Python 3.11+ | 生态丰富，开发效率高 |
| | FastAPI | 高性能异步，自动文档 |
| | Pydantic | 数据验证 |
| **浏览器自动化** | Playwright | 现代化 API，SPA 支持好 |
| **数据库** | SQLite | 轻量级，单机部署 |
| | SQLAlchemy | ORM 支持 |
| **实时通信** | WebSocket | 实时推送 |
| **LLM 接入** | OpenAI Compatible API | 支持多种 LLM |
| **通知服务** | Discord.py / python-telegram-bot | 官方 SDK |
| **OSD 显示** | PyQt6 | 跨平台，功能强大 |
| **任务调度** | APScheduler | 定时任务 |
| **日志记录** | Loguru | 简洁易用 |

---

### 2.3 部署架构

```
┌──────────────────────────────────────────────────────────┐
│           Hyper-V 虚拟机 (Windows 11)                     │
│                                                           │
│  ┌────────────────────────────────────────────────────┐  │
│  │  Chrome/Edge (已手动登录币安)                      │  │
│  │  --remote-debugging-port=9222                      │  │
│  └────────────────────────────────────────────────────┘  │
│                        ↕                                  │
│  ┌────────────────────────────────────────────────────┐  │
│  │  后端服务 (FastAPI :8000)                          │  │
│  │  进程管理: PM2 / nssm                              │  │
│  └────────────────────────────────────────────────────┘  │
│                        ↕                                  │
│  ┌────────────────────────────────────────────────────┐  │
│  │  前端服务 (Nginx :80 / Vite Dev :5173)             │  │
│  └────────────────────────────────────────────────────┘  │
│                        ↕                                  │
│  ┌────────────────────────────────────────────────────┐  │
│  │  OSD 显示窗口 (PyQt6)                              │  │
│  └────────────────────────────────────────────────────┘  │
│                                                           │
│  ┌────────────────────────────────────────────────────┐  │
│  │  数据存储                                           │  │
│  │  • data/alpha-score.db                             │  │
│  │  • config/settings.yaml                            │  │
│  │  • config/ladders.yaml (阶梯配置)                  │  │
│  │  • logs/                                           │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

---

## 3. 核心模块详细设计

### 3.1 Web 管理界面模块（第一阶段）

#### 3.1.1 模块职责
- 提供用户登录认证
- 实时监控交易状态
- 配置管理（参数设置、阶梯设计）
- 历史数据查询和分析
- 日志查看和审计

#### 3.1.2 主要页面设计

**1. 仪表盘（Dashboard）**

功能：
- 今日积分进度（当前/目标，进度条）
- 今日交易统计（交易额、次数、磨损）
- 系统运行状态（模式、运行时长、最后操作）
- 资金概览（可用资金、持仓、网格投入）
- 实时盘口快照（买一卖一、价差、ATR）

设计要点：
- 使用卡片布局，信息密度适中
- 关键数据支持点击查看详情
- 异常数据高亮显示（红色警告）
- WebSocket 实时更新（延迟 < 1s）

**2. 交易监控页**

功能：
- 实时交易列表（表格，最新 100 条）
- 交易图表（K 线 + 买卖点标记）
- 盘口深度图
- 技术指标图表（ATR、波动率）

设计要点：
- 表格支持排序、筛选、分页
- 图表支持缩放、时间范围选择
- 成功/失败交易用不同颜色区分

**3. 参数配置页**

功能模块：
- **积分获取配置**
  - 目标积分设置
  - 交易代币选择
  - 订单参数（偏移量、仓位比例）
  - 风控参数（ATR 限制、交易上限）

- **阶梯设计器**（重点）
  - 可视化阶梯编辑器
  - 资金阶梯配置（金额范围 → 基础积分）
  - 交易量阶梯配置（交易额范围 → 交易积分）
  - 阶梯预览和验证
  - 积分计算模拟器

- **网格交易配置**
  - 币种选择、价格区间、网格数量
  - 资金分配、止损止盈

- **行为模拟配置**
  - 延迟范围、鼠标速度、浏览频率

- **通知配置**
  - 各渠道 Token/Webhook
  - 通知触发条件

设计要点：
- 配置项分组，使用折叠面板
- 输入框支持实时验证
- 修改后显示保存/应用按钮
- 提供"恢复默认值"功能

**4. 历史数据页**

功能：
- 交易历史查询（日期范围、代币筛选）
- 积分历史图表（折线图）
- 磨损分析报告（饼图、柱状图）
- 资金曲线图
- 数据导出（CSV/Excel）

**5. 日志查询页**

功能：
- 日志列表（分页、搜索、过滤）
- 日志级别筛选（INFO/WARNING/ERROR）
- 日志详情查看
- 日志下载

**6. 系统设置页**

功能：
- 用户管理（密码修改）
- 浏览器连接设置（调试端口）
- OSD 显示设置（位置、透明度、内容）
- 数据备份/恢复

#### 3.1.3 前端技术要点

**状态管理（Pinia）**
```typescript
// stores/trading.ts (概念示意)
export const useTradingStore = defineStore('trading', {
  state: () => ({
    currentPrice: 0,
    orderBook: { bids: [], asks: [] },
    todayStats: { points: 0, volume: 0, cost: 0 }
  }),
  actions: {
    connectWebSocket() { /* WebSocket 连接逻辑 */ },
    updatePrice(price) { this.currentPrice = price }
  }
})
```

**实时通信**
- 使用 Socket.IO Client
- 自动重连机制
- 消息队列缓冲（防止丢失）

**响应式设计**
- 支持桌面和平板访问
- 关键页面支持全屏模式

---

### 3.2 OSD 显示模块（第二阶段）

#### 3.2.1 模块职责
- 实时叠加显示交易信息
- 透明置顶，不遮挡操作
- 可拖拽、可配置样式

#### 3.2.2 显示内容设计

**核心显示项**（基于问卷反馈）：
1. **当前积分**：`积分: 12.5/18.0 (69.4%)`
2. **今日交易额**：`交易额: 8,450 USDT`
3. **磨损统计**：`磨损: 3.25 USDT (0.038%)`
4. **盘口信息**：
   - 买一：`0.005432 (1,250)`
   - 卖一：`0.005438 (980)`
   - 价差：`0.000006 (0.11%)`
5. **磨损预测**：`预测磨损: 0.18 USDT`
6. **盘口深度**（可选，展开显示）：
   - 买盘前 5 档
   - 卖盘前 5 档

**显示布局**：
```
┌──────────────────────────────┐
│ 积分: 12.5/18.0 (69.4%) ▲   │  ← 标题栏（可拖拽）
├──────────────────────────────┤
│ 交易额: 8,450 USDT           │
│ 磨损: 3.25 USDT (0.038%)     │
│                              │
│ 买一: 0.005432 (1,250)       │
│ 卖一: 0.005438 (980)         │
│ 价差: 0.000006 (0.11%)       │
│                              │
│ 预测磨损: 0.18 USDT          │
└──────────────────────────────┘
```

#### 3.2.3 技术实现要点

**技术选型**：PyQt6（支持透明窗口、置顶显示、拖拽）

**关键特性**：
- 窗口标志：`WindowStaysOnTopHint + FramelessWindowHint`
- 背景透明：`WA_TranslucentBackground`
- 数据更新：定时器（500ms）+ HTTP API
- 拖拽功能：重写 `mousePressEvent` 和 `mouseMoveEvent`
- 样式配置：读取配置文件（位置、透明度、字体）

---

### 3.3 数据监控采集模块

#### 3.3.1 模块职责
- 实时采集盘口数据
- 计算技术指标（ATR、波动率）
- 查询账户信息（积分、余额）
- 数据持久化存储
- 数据广播（WebSocket）

#### 3.3.2 采集策略

**采集频率**：
- 盘口数据：500ms / 次（高频）
- 技术指标：5s / 次（中频）
- 账户信息：10s / 次（低频）

**数据缓冲**：
- 内存缓冲区保留最近 1000 条数据
- 用于计算技术指标（ATR 需要历史数据）

**异常处理**：
- 采集失败时重试（最多 3 次）
- 连续失败时降级（使用缓存数据）
- 严重异常时暂停交易并通知

#### 3.3.3 数据采集流程

```
1. 定位盘口元素（等待加载完成）
2. 提取买卖盘数据（前 5 档）
3. 提取最新成交价
4. 计算技术指标（ATR、波动率）
5. 保存到缓冲区
6. 存储到数据库（批量写入，每 10s）
7. 广播到 WebSocket 客户端
```

---

### 3.4 策略引擎模块（核心）

#### 3.4.1 积分优化子模块

**模块职责**：
- 根据阶梯配置计算积分
- 根据目标积分计算所需交易额
- 提供交易计划（剩余交易量、预计时间）

**币安 Alpha 积分规则（阶梯制）**：

```
总积分 = 基础积分 + 交易积分

基础积分 = 根据账户资金总量查询阶梯表得到
交易积分 = 根据每日交易量查询阶梯表得到
```

**阶梯配置示例**：

```yaml
# config/ladders.yaml

# 资金阶梯（账户总资产 → 基础积分）
balance_ladders:
  - range: [0, 1000]          # 0-1000 USDT
    points: 1.0               # 固定 1 分
  - range: [1000, 5000]       # 1000-5000 USDT
    points: 5.0               # 固定 5 分
  - range: [5000, 10000]
    points: 10.0
  - range: [10000, null]      # 10000+ USDT
    points: 20.0

# 交易量阶梯（每日交易额 → 交易积分）
volume_ladders:
  - range: [0, 1000]          # 0-1000 USDT
    points: 0.0               # 0 分
  - range: [1000, 5000]       # 1000-5000 USDT
    points: 2.0               # 固定 2 分
  - range: [5000, 10000]
    points: 5.0
  - range: [10000, 20000]
    points: 10.0
  - range: [20000, null]
    points: 15.0
```

**阶梯设计器功能**：

1. **可视化编辑**：
   - 表格形式编辑阶梯（范围、积分）
   - 支持增删改阶梯
   - 范围连续性验证（不能有空隙或重叠）

2. **积分计算模拟器**：
   - 输入资金和交易量
   - 实时显示对应积分
   - 验证阶梯配置正确性

3. **配置导入导出**：
   - 导出为 YAML 文件
   - 导入其他阶梯配置

**计算逻辑**：

```
function calculate_points(balance, volume):
    base_points = lookup_ladder(balance_ladders, balance)
    trade_points = lookup_ladder(volume_ladders, volume)
    return base_points + trade_points

function lookup_ladder(ladders, value):
    for ladder in ladders:
        if ladder.range[0] <= value < ladder.range[1]:
            return ladder.points
    return 0
```

**交易计划生成**：

```
function generate_trading_plan(target_points, current_balance, current_volume):
    base_points = lookup_ladder(balance_ladders, current_balance)
    required_trade_points = target_points - base_points

    # 查找需要达到的交易量阶梯
    for ladder in volume_ladders:
        if ladder.points >= required_trade_points:
            target_volume = ladder.range[0]
            break

    remaining_volume = max(0, target_volume - current_volume)

    return {
        'target_points': target_points,
        'base_points': base_points,
        'required_trade_points': required_trade_points,
        'target_volume': target_volume,
        'current_volume': current_volume,
        'remaining_volume': remaining_volume,
        'progress': current_volume / target_volume * 100
    }
```

---

#### 3.4.2 订单生成子模块

**模块职责**：
- 根据盘口和配置生成最优买卖订单
- 计算预估磨损
- 支持反向限价单策略

**订单生成策略**：

1. **反向限价单**（降低磨损）：
   - 买单：略高于买一价（如 +0.1%）
   - 卖单：略低于卖一价（如 -0.1%）
   - 目标：尽快成交，减少滑点

2. **偏移量配置**：
   - 支持正负偏移量（基点 bp）
   - 买单偏移：`buy_price = bid_price * (1 + buy_offset_bp / 10000)`
   - 卖单偏移：`sell_price = ask_price * (1 - sell_offset_bp / 10000)`

3. **磨损计算**：
   ```
   买入成本 = 买入金额 * 买入手续费率
   卖出成本 = 卖出金额 * 卖出手续费率
   价差成本 = 数量 * (买入价 - 卖出价)
   总磨损 = 买入成本 + 卖出成本 + 价差成本
   ```

**风控检查**（生成订单前）：
- ATR 是否超限
- 仓位比例是否超限
- 今日交易量是否达到上限
- 盘口流动性是否充足

---

#### 3.4.3 网格交易子模块

**模块职责**：
- 管理网格策略参数
- 生成网格买卖信号
- 执行网格交易
- 监控网格收益

**网格策略设计**：

1. **网格初始化**：
   ```
   价格区间 = [下限, 上限]
   网格间距 = (上限 - 下限) / (网格数量 - 1)

   for i in range(网格数量):
       网格价格 = 下限 + i * 网格间距
       每格投资 = 总资金 / 网格数量
       每格数量 = 每格投资 / 网格价格
   ```

2. **交易信号生成**：
   - 价格下跌到网格档位 → 买入信号
   - 价格上涨到已持仓档位 → 卖出信号

3. **风控机制**：
   - 止损：单边下跌超过 X% 停止并清仓
   - 止盈：总收益达到 Y% 停止并清仓
   - 监控：总亏损超过阈值时报警

**网格参数配置方式**：
- 手动设置：用户直接设置上下限
- 历史波动率：基于 N 天波动率自动计算
- 技术指标：基于布林带等指标自动计算

---

### 3.5 交易执行与风控模块

#### 3.5.1 交易执行器

**模块职责**：
- 执行买卖订单（通过 Playwright）
- 订单状态监控
- 撤单处理

**执行流程**：
```
1. 接收订单指令
2. 导航到交易页面
3. 切换到限价单模式
4. 选择买入/卖出
5. 输入价格和数量（模拟人类输入）
6. 提交订单
7. 等待成交确认
8. 记录订单 ID
9. 返回执行结果
```

**失败处理**：
- 订单提交失败 → 重试（最多 3 次）
- 成交超时 → 撤单并重新下单
- 严重异常 → 暂停交易并通知

---

#### 3.5.2 风控引擎

**模块职责**：
- 实时监控风险指标
- 触发风控规则时暂停交易
- 记录风控事件

**风控规则**：

| 规则类别 | 检查项 | 触发条件 | 处理方式 |
|---------|--------|---------|---------|
| **市场风控** | ATR 检测 | ATR > 最大值 | 暂停下单，等待 ATR 回落 |
| | 价格剧烈波动 | 短时间内涨跌 > X% | 暂停交易，人工确认 |
| **仓位风控** | 持仓比例 | 持仓 > 可用资金 * Y% | 禁止买入，只允许卖出 |
| | 单日交易量 | 交易量 > 每日上限 | 停止交易，次日重置 |
| **亏损风控** | 连续亏损 | 连续 N 次亏损 | 暂停交易，人工检查策略 |
| | 总亏损 | 累计亏损 > 止损阈值 | 停止所有交易，清仓 |
| **异常风控** | 登录状态 | 检测到登出 | 暂停交易，发送通知 |
| | 网络连接 | 连接中断 | 暂停交易，自动重连 |

**风控统计**：
- 记录每次风控触发事件
- 统计风控触发频率
- 生成风控报告

---

### 3.6 人性化行为模拟模块

#### 3.6.1 模块职责
- 为所有自动化操作增加人类特征
- 规避平台风控检测

#### 3.6.2 行为模拟策略

**1. 随机延迟**
- 操作间延迟：1-3 秒（可配置）
- 输入字符延迟：50-150ms / 字符
- 点击后延迟：100-300ms

**2. 鼠标移动**
- 使用贝塞尔曲线（二次或三次）
- 移动速度：极慢（模拟人类）
- 随机抖动：小幅度随机偏移

**3. 随机浏览行为**
- 随机滚动页面（上下）
- 随机悬停在元素上
- 模拟阅读（停留 1-3 秒）
- 频率：中等（60-120 秒一次）

**4. 操作随机化**
- 价格输入方式：有时直接输入，有时点击价格后微调
- 点击位置：在元素范围内随机选择
- 操作顺序：偶尔先查看其他页面再返回交易

---

### 3.7 LLM 能力接入模块（第三阶段）

#### 3.7.1 模块职责
- 市场行情分析（辅助决策）
- 页面元素识别（视觉模型）
- 异常检测（行为分析）

#### 3.7.2 应用场景

**1. 市场分析**
- 输入：当前盘口、ATR、波动率等
- 输出：是否适合交易 + 建议理由
- 使用：作为风控的辅助判断

**2. 页面元素识别**
- 输入：页面截图
- 输出：元素位置坐标
- 使用：页面结构变化时自动适配

**3. 异常检测**
- 输入：交易日志、系统行为
- 输出：异常判断 + 原因分析
- 使用：发现潜在风险

#### 3.7.3 API 接入规范

**支持的 LLM 服务**：
- DeepSeek（推荐，性价比高）
- Gemini（视觉能力强）
- Ollama（本地部署，隐私性好）

**接口统一**：
- 使用 OpenAI Compatible API 标准
- 配置：API Key、Base URL、模型名称
- 支持切换不同服务

---

## 4. 数据模型设计

### 4.1 数据库表设计

**核心表**：
1. **users**：用户表（用户名、密码哈希）
2. **config**：配置表（KV 存储）
3. **trades**：交易记录表（买卖记录、磨损）
4. **market_data**：市场数据表（OHLCV、ATR）
5. **orderbook_snapshots**：盘口快照表（买卖盘）
6. **points_history**：积分历史表（每日积分）
7. **grid_trades**：网格交易记录表
8. **system_logs**：系统日志表

**设计原则**：
- 使用自增主键
- 时间字段使用 TIMESTAMP
- 价格和数量使用 DECIMAL（高精度）
- 建立必要的索引（user_id、timestamp、symbol）

---

### 4.2 配置文件设计

**主配置文件**：`config/settings.yaml`

```yaml
# 系统配置
system:
  debug_port: 9222
  api_port: 8000
  log_level: INFO

# 交易配置
trading:
  symbol: "KOGE/USDT"
  buy_offset_bp: 10        # 买单偏移 10 基点
  sell_offset_bp: -10      # 卖单偏移 -10 基点
  position_ratio: 0.5      # 单次下单 50% 仓位
  fee_rate_buy: 0.001      # 买入手续费 0.1%
  fee_rate_sell: 0.001     # 卖出手续费 0.1%

# 风控配置
risk:
  max_atr: 0.01            # 最大 ATR 1%
  max_daily_volume: 50000  # 每日最大交易量 50000 USDT
  max_position_ratio: 0.8  # 最大持仓 80%
  stop_loss: 100           # 总止损 100 USDT

# 行为模拟配置
behavior:
  delay_min: 1.0
  delay_max: 3.0
  mouse_speed: "slow"
  random_frequency: "medium"

# 通知配置
notifications:
  discord:
    enabled: true
    webhook: "..."
  telegram:
    enabled: true
    bot_token: "..."
    chat_id: "..."
```

**阶梯配置文件**：`config/ladders.yaml`（见 3.4.1 节）

---

## 5. 接口设计规范

### 5.1 RESTful API 设计

**接口命名规范**：
- 使用复数名词（如 `/api/trades` 而非 `/api/trade`）
- 使用小写和连字符（如 `/api/order-book`）
- 版本控制（如 `/api/v1/trades`）

**HTTP 方法**：
- GET：查询数据
- POST：创建资源、执行操作
- PUT：更新资源
- DELETE：删除资源

**响应格式**：
```json
{
  "code": 200,
  "message": "Success",
  "data": { /* 具体数据 */ },
  "timestamp": "2025-11-25T10:30:00Z"
}
```

**错误响应**：
```json
{
  "code": 400,
  "message": "Invalid parameters",
  "error": "buy_offset_bp must be a number",
  "timestamp": "2025-11-25T10:30:00Z"
}
```

---

### 5.2 WebSocket 接口设计

**连接地址**：`ws://localhost:8000/ws`

**消息格式**：
```json
{
  "type": "price_update | trade_executed | orderbook_update | ...",
  "data": { /* 具体数据 */ },
  "timestamp": "2025-11-25T10:30:00Z"
}
```

**消息类型**：
- `price_update`：价格更新
- `orderbook_update`：盘口更新
- `trade_executed`：交易执行
- `risk_alert`：风控警告
- `system_status`：系统状态变化

---

## 6. 关键技术方案

### 6.1 浏览器自动化方案

**连接方式**：
- 使用 Playwright 的 `connect_over_cdp` 连接已运行的浏览器
- 浏览器启动参数：`--remote-debugging-port=9222`
- 复用用户手动登录的会话（最大化隐蔽性）

**登录状态检测**：
- 定期检查登录标识元素
- 登录失效时发送通知，暂停交易

**异常恢复**：
- 浏览器崩溃：自动重启浏览器并重连
- 页面卡死：刷新页面并重新定位元素
- 网络中断：等待恢复后自动重连

---

### 6.2 数据持久化方案

**SQLite 优化**：
- 使用 WAL 模式（Write-Ahead Logging）提升并发性能
- 批量写入（每 10 秒或 100 条记录）
- 定期清理历史数据（保留最近 30 天）

**配置热重载**：
- 使用文件监控（watchdog 库）
- 配置文件变化时自动重新加载
- 重载前验证配置合法性

---

### 6.3 多进程/多线程方案

**进程/线程划分**：
- **主进程**：FastAPI 后端服务
- **子进程 1**：浏览器自动化（Playwright）
- **子进程 2**：OSD 显示窗口（PyQt6）
- **线程池**：数据采集、策略计算、交易执行

**进程间通信**：
- 使用队列（multiprocessing.Queue）
- 共享状态通过 Redis 或共享内存

---

## 7. 开发计划与迭代路线

### 7.1 开发阶段

| 阶段 | 时间 | 主要任务 | 交付物 |
|-----|------|---------|--------|
| **第一阶段** | Week 1-2 | Web 管理界面开发 | 完整的 Web 界面（登录、仪表盘、配置、日志） |
| **第二阶段** | Week 3 | OSD 显示开发 | OSD 窗口（透明置顶、实时更新） |
| **第三阶段** | Week 4 | LLM 能力接入 | LLM 客户端（市场分析、元素识别） |
| **第四阶段** | Week 5-6 | MVP 开发 | 核心交易功能（半自动模式、基础风控） |
| **第五阶段** | Week 7 | 完整系统 | 全自动模式、完善风控、通知系统 |
| **第六阶段** | Week 8-9 | 网格交易 | 网格策略、资金调配 |
| **测试优化** | Week 10 | 测试和文档 | 测试报告、用户手册、部署文档 |

**总计**：10 周（2.5 个月）

---

### 7.2 第一阶段详细任务（Web 管理界面）

**Week 1**：
- [ ] 项目初始化（前端 Vue3 + 后端 FastAPI）
- [ ] 用户认证系统（登录/登出/JWT）
- [ ] 数据库模型设计与初始化
- [ ] 仪表盘页面（静态数据展示）

**Week 2**：
- [ ] WebSocket 实时通信
- [ ] 配置管理页面（含阶梯设计器）
- [ ] 交易监控页面（表格 + 图表）
- [ ] 日志查询页面

---

## 8. 开发规范与约定

### 8.1 代码规范

**Python（后端）**：
- 遵循 PEP 8 规范
- 使用 Black 格式化代码
- 使用 Pylint / Flake8 静态检查
- 类型注解（Type Hints）

**TypeScript（前端）**：
- 遵循 ESLint 规范
- 使用 Prettier 格式化
- 启用严格模式（strict mode）

**命名规范**：
- 变量/函数：snake_case（Python）、camelCase（TypeScript）
- 类名：PascalCase
- 常量：UPPER_SNAKE_CASE

---

### 8.2 Git 规范

**分支管理**：
- `main`：稳定版本
- `develop`：开发分支
- `feature/*`：功能分支
- `hotfix/*`：紧急修复

**提交信息**：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型**：
- `feat`：新功能
- `fix`：修复 Bug
- `docs`：文档更新
- `refactor`：重构
- `test`：测试
- `chore`：构建/配置

---

### 8.3 目录结构

```
alpha-score/
├── .github/
│   └── workflows/              # GitHub Actions CI/CD
├── .vscode/
│   └── settings.json           # VS Code 配置
├── .cursor/
│   └── rules/                  # Cursor AI 规则
├── .kiro/
│   └── steering/               # Kiro AI 提示词配置
├── .claude/
│   └── claude.md               # Claude AI 提示词配置
├── .windsurf/
│   └── rules/                  # Windsurf AI 配置
├── prompts/
│   ├── kimi.md                 # KIMI AI 提示词配置
│   ├── development.md          # 开发阶段提示词
│   └── testing.md              # 测试阶段提示词
│
├── backend/
│   ├── api/
│   │   ├── __init__.py
│   │   ├── routes.py           # API 路由定义
│   │   └── websocket.py        # WebSocket 处理
│   ├── modules/
│   │   ├── browser/            # 浏览器自动化
│   │   ├── data/               # 数据采集
│   │   ├── strategy/           # 策略引擎
│   │   ├── execution/          # 交易执行
│   │   ├── risk/               # 风控引擎
│   │   ├── behavior/           # 行为模拟
│   │   ├── llm/                # LLM 接入
│   │   └── osd/                # OSD 显示
│   ├── models/
│   │   └── database.py         # 数据库模型
│   ├── utils/
│   │   ├── logger.py           # 日志工具
│   │   ├── notifier.py         # 通知工具
│   │   └── config.py           # 配置管理
│   ├── main.py                 # 入口文件
│   ├── requirements.txt        # Python 依赖
│   └── pytest.ini              # 测试配置
│
├── frontend/
│   ├── src/
│   │   ├── api/                # API 封装
│   │   ├── assets/             # 静态资源
│   │   ├── components/         # 通用组件
│   │   ├── layouts/            # 布局组件
│   │   ├── pages/              # 页面组件
│   │   ├── router/             # 路由配置
│   │   ├── stores/             # Pinia stores
│   │   ├── types/              # TypeScript 类型
│   │   ├── utils/              # 工具函数
│   │   ├── App.vue
│   │   └── main.ts
│   ├── public/
│   ├── package.json
│   ├── tsconfig.json
│   └── vite.config.ts
│
├── data/
│   └── alpha-score.db          # SQLite 数据库
│
├── config/
│   ├── settings.yaml           # 主配置文件
│   ├── ladders.yaml            # 阶梯配置文件
│   └── secrets.yaml            # 敏感配置（不提交 Git）
│
├── logs/
│   ├── app.log                 # 应用日志
│   ├── error.log               # 错误日志
│   └── trade.log               # 交易日志
│
├── docs/
│   ├── requirement.md          # 原始需求文档
│   ├── requirement_refined.md  # 整理后需求文档
│   ├── requirement_survey.md   # 需求调研问卷
│   ├── system_design.md        # 系统设计文档（本文档）
│   ├── api_docs.md             # API 文档
│   ├── user_manual.md          # 用户手册
│   └── deployment.md           # 部署文档
│
├── tests/
│   ├── unit/                   # 单元测试
│   ├── integration/            # 集成测试
│   └── e2e/                    # 端到端测试
│
├── scripts/
│   ├── start_browser.bat       # 启动浏览器（Windows）
│   ├── start_backend.sh        # 启动后端
│   └── deploy.sh               # 部署脚本
│
├── .gitignore
├── .env.example                # 环境变量示例
├── README.md                   # 项目说明
└── LICENSE
```

---

### 8.4 AI Coding Agent 配置文件

#### `.claude/claude.md` - Claude AI 配置

```markdown
# Claude AI 开发助手配置

## 项目概述
Binance Alpha 自动化交易工具 - 用于自动化获取 Alpha 积分和网格交易

## 开发原则
1. 隐蔽性优先：所有操作必须模拟人类行为
2. 安全第一：严格风控，保护用户资金
3. 模块化设计：高内聚、低耦合
4. 配置化：所有参数可配置

## 技术栈
- 后端：Python 3.11+ / FastAPI / Playwright / SQLite
- 前端：Vue 3 / TypeScript / Vite / Element Plus
- OSD：PyQt6

## 代码规范
- Python：PEP 8 + Type Hints + Black
- TypeScript：ESLint + Prettier + Strict Mode

## 常用命令
- 启动后端：`cd backend && uvicorn main:app --reload`
- 启动前端：`cd frontend && npm run dev`
- 运行测试：`pytest tests/`

## 注意事项
- 所有浏览器操作必须包含行为模拟（随机延迟、鼠标移动）
- 配置变更后需验证合法性
- 关键操作需记录日志
- 异常情况需发送通知
```

---

#### `.kiro/steering/project.md` - Kiro AI 配置

```markdown
# Kiro AI 项目配置

## 项目信息
- 项目名称：Binance Alpha 自动化交易工具
- 项目类型：Web 应用 + 自动化脚本
- 主要语言：Python, TypeScript

## 开发指南
### 模块划分
- 前端：Vue3 单页应用
- 后端：FastAPI 异步服务
- 自动化：Playwright 浏览器控制
- 显示：PyQt6 OSD 窗口

### 关键约束
1. 浏览器操作必须隐蔽（模拟人类）
2. 风控规则严格执行
3. 配置实时生效
4. 异常必须通知

### 编码规范
- 使用类型注解
- 添加详细注释
- 编写单元测试
- 遵循项目规范
```

---

#### `prompts/kimi.md` - KIMI AI 配置

```markdown
# KIMI AI 开发提示词

你是一个专业的 Python/TypeScript 开发工程师，正在开发 Binance Alpha 自动化交易系统。

## 项目背景
- 目标：自动化获取币安 Alpha 积分，并通过网格交易创造额外收益
- 核心原则：隐蔽性、安全性、稳定性

## 技术要求
1. **隐蔽性**：所有浏览器操作必须模拟人类行为
   - 随机延迟（1-3 秒）
   - 贝塞尔曲线鼠标移动
   - 随机浏览行为

2. **风控**：严格的风险控制
   - ATR 检测
   - 仓位控制
   - 止损机制

3. **代码质量**：
   - 使用类型注解
   - 添加详细注释
   - 异常处理完善
   - 编写单元测试

## 开发规范
- Python：PEP 8 + Black + Type Hints
- TypeScript：ESLint + Prettier + Strict
- Git：Conventional Commits

## 示例代码风格
```python
from typing import Optional
from dataclasses import dataclass

@dataclass
class Order:
    """订单数据类"""
    side: str  # 'buy' or 'sell'
    price: float
    quantity: float

async def execute_order(order: Order) -> Optional[dict]:
    """执行订单

    Args:
        order: 订单对象

    Returns:
        执行结果，失败返回 None
    """
    try:
        # 实现逻辑
        pass
    except Exception as e:
        logger.error(f"订单执行失败: {e}")
        return None
```

请按照以上规范和风格编写代码。
```

---

#### `.cursor/rules/development.md` - Cursor AI 开发规则

```markdown
# Cursor AI 开发规则

## 项目规则
1. 始终使用类型注解（Python Type Hints / TypeScript）
2. 浏览器操作必须包含行为模拟代码
3. 关键操作必须记录日志
4. 异常处理必须完善
5. 配置参数必须可配置化

## 代码质量
- 函数复杂度不超过 15
- 单个文件不超过 500 行
- 测试覆盖率 > 80%

## 安全要求
- 敏感配置不硬编码
- API Key 使用环境变量
- 用户密码必须哈希存储
```

---

#### `.windsurf/rules/coding.md` - Windsurf AI 规则

```markdown
# Windsurf AI 编码规则

## 项目约束
- 隐蔽性：所有自动化操作模拟人类
- 安全性：严格风控，保护资金
- 稳定性：完善异常处理

## 编码标准
- Python：Black + Pylint
- TypeScript：ESLint + Prettier
- 提交：Conventional Commits
```

---

## 9. 风险评估与应对策略

### 9.1 技术风险

| 风险 | 概率 | 影响 | 应对策略 |
|-----|------|------|---------|
| 币安页面结构变化 | 高 | 高 | 多种元素定位方式、LLM 视觉识别、定期检查 |
| Playwright 被检测 | 中 | 极高 | 远程调试连接、极致行为模拟、限制频率 |
| 网络不稳定 | 中 | 中 | 重连机制、异常重试、数据缓存 |
| 数据采集失败 | 低 | 中 | 多重校验、降级策略、及时通知 |

---

### 9.2 业务风险

| 风险 | 概率 | 影响 | 应对策略 |
|-----|------|------|---------|
| 币安风控封号 | 中 | 极高 | 极致行为模拟、小额测试、多账户分散 |
| 市场剧烈波动 | 高 | 高 | ATR 检测、异常暂停、止损机制 |
| 资金损失 | 中 | 极高 | 严格风控、小额起步、逐步放大 |
| 积分规则变化 | 低 | 中 | 阶梯配置灵活、快速适配 |

---

### 9.3 合规风险

**重要声明**：
- 本系统可能违反币安服务条款
- 用户需自行承担所有法律和财务风险
- 仅供个人学习和研究使用
- 不得用于商业用途

---

## 10. 总结

本系统设计文档从需求分析、架构设计、模块划分、接口规范、技术方案等多个维度，详细规划了 Binance Alpha 自动化交易工具的设计和实现。

### 核心设计亮点

1. **阶梯制积分计算**：准确反映币安 Alpha 规则，支持可视化阶梯设计器
2. **极致隐蔽性设计**：远程调试连接 + 完善行为模拟，最大化规避风控
3. **完善的风控机制**：多层次风险检测，保护用户资金安全
4. **模块化架构**：清晰的模块划分，便于维护和扩展
5. **全面的可观测性**：Web 界面 + OSD 显示 + 多渠道通知
6. **AI 增强能力**：LLM 辅助决策、元素识别、异常检测
7. **完整的开发规范**：代码规范、Git 规范、AI Agent 配置

### 开发建议

1. **严格按照迭代计划执行**，确保每个阶段交付物完整
2. **优先实现核心功能**，后续再完善扩展功能
3. **小额资金测试**，验证策略有效性后逐步放大
4. **持续优化行为模拟**，定期检查是否被检测
5. **完善文档和注释**，便于维护和协作

### 风险提示

- 自动化交易存在资金损失风险
- 可能违反平台服务条款导致封号
- 用户需自行承担所有责任
- 建议仅用于个人学习研究

---

**文档版本**：v1.1
**最后更新**：2025-11-25
**文档状态**：已完成，待开发实施
